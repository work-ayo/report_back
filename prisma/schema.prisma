// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GlobalRole {
  ADMIN
  USER
}

enum TeamRole {
  MEMBER
}

model User {
  userId     String     @id @default(cuid()) @db.VarChar(32)
  id         String     @unique @db.VarChar(50)
  password   String     @db.VarChar(255)
  name       String     @db.VarChar(100)
  department String?    @db.VarChar(100)
  globalRole GlobalRole @default(USER)
  isActive   Boolean    @default(true)
  lastLoginAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships    TeamMember[]
  createdTeams   Team[]        @relation("TeamCreator")
  reports        WeeklyReport[]
  boardsCreated  Board[]
  cardsCreated   Card[]        @relation("CardCreator")

  columnsCreated  Column[]   @relation("ColumnCreator")
  projectsCreated Project[]  @relation("ProjectCreator")
}

model Team {
  teamId   String @id @default(cuid()) @db.VarChar(32)
  name     String @db.VarChar(100)
  joinCode String @unique @db.VarChar(32)

  createdByUserId String? @db.VarChar(32)
  createdBy       User?   @relation("TeamCreator", fields: [createdByUserId], references: [userId], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  TeamMember[]
  reports  WeeklyReport[]
  boards   Board[]
  projects Project[]
}

model TeamMember {
  id       String   @id @default(cuid()) @db.VarChar(32)
  teamId   String   @db.VarChar(32)
  userId   String   @db.VarChar(32)
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [teamId], onDelete: Cascade)
  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
}

model WeeklyReport {
  reportId String @id @default(cuid()) @db.VarChar(32)
  teamId   String @db.VarChar(32)
  userId   String @db.VarChar(32)

  // 주의 월요일 00:00(UTC) 기준
  weekStart DateTime

  thisWeek String  @db.Text
  nextWeek String  @db.Text
  issue    String? @db.Text
  solution String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [teamId], onDelete: Cascade)
  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([teamId, userId, weekStart])
  @@index([userId, weekStart])
  @@index([teamId, weekStart])
}

model Board {
  boardId         String @id @default(cuid()) @db.VarChar(32)
  teamId          String @db.VarChar(32)
  name            String @db.VarChar(120)
  createdByUserId String @db.VarChar(32)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team @relation(fields: [teamId], references: [teamId], onDelete: Cascade)
  createdBy User @relation(fields: [createdByUserId], references: [userId], onDelete: Cascade)

  columns Column[]
  cards   Card[]

  @@index([teamId])
}

model Column {
  columnId String @id @default(cuid()) @db.VarChar(32)
  boardId  String @db.VarChar(32)
  name     String @db.VarChar(80)
  order    Int

  createdByUserId String? @db.VarChar(32)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board Board @relation(fields: [boardId], references: [boardId], onDelete: Cascade)
  cards Card[]

  createdBy User? @relation("ColumnCreator", fields: [createdByUserId], references: [userId], onDelete: SetNull)

  @@unique([boardId, order])
  @@index([boardId])
  @@index([createdByUserId])
}

model Project {
  projectId String @id @default(cuid()) @db.VarChar(32)

  teamId String @db.VarChar(32)
  code   String @db.VarChar(50)
  name   String @db.VarChar(200)

  // 원 단위(정수)
  price BigInt @default(0)

  // 프로젝트 시작, 마감일
  startDate DateTime?
  endDate   DateTime?

  createdByUserId String? @db.VarChar(32)
  createdBy       User?   @relation("ProjectCreator", fields: [createdByUserId], references: [userId], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team  Team  @relation(fields: [teamId], references: [teamId], onDelete: Cascade)
  cards Card[]

  @@unique([teamId, code])
  @@index([teamId])
  @@index([createdByUserId])
}

model Card {
  cardId   String @id @default(cuid()) @db.VarChar(32)
  boardId  String @db.VarChar(32)
  columnId String @db.VarChar(32)

  projectId String?  @db.VarChar(32)
  project   Project? @relation(fields: [projectId], references: [projectId], onDelete: SetNull)

  title   String  @db.VarChar(200)
  content String? @db.Text
  dueDate DateTime?

  order Int

  createdByUserId String @db.VarChar(32)
  createdBy       User   @relation("CardCreator", fields: [createdByUserId], references: [userId], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board  Board  @relation(fields: [boardId], references: [boardId], onDelete: Cascade)
  column Column @relation(fields: [columnId], references: [columnId], onDelete: Cascade)

  @@unique([columnId, order])
  @@index([boardId])
  @@index([columnId])
  @@index([projectId])
}
